name: Deploy FastAPI (Production)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add droplet to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 134.122.5.11 >> ~/.ssh/known_hosts

      - name: Deploy to DigitalOcean Droplet
        env:
          DROPLET_HOST: 134.122.5.11
          DROPLET_USER: kevinlin192003
          APP_DIR: /var/www/fastapi-app
          PM2_APP_NAME: fastapi-app
          DATABASE_URL_RAW: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail

          echo "== Sanitize DATABASE_URL =="
          DATABASE_URL_CLEAN="$(printf "%s" "$DATABASE_URL_RAW" | tr -d '\r\n')"

          echo "== Local verification =="
          python3 -c "import urllib.parse; u='${DATABASE_URL_CLEAN}'; p=urllib.parse.urlparse(u); print(repr(u)); print('db path:', repr(p.path))"

          echo "== SSH deploy =="
          ssh "${DROPLET_USER}@${DROPLET_HOST}" "
            set -euo pipefail
            cd ${APP_DIR}

            git fetch --all
            git reset --hard origin/main

            source venv/bin/activate
            pip install -r requirements.txt

            export DATABASE_URL='${DATABASE_URL_CLEAN}'
            export DATABASE_URL=\$(printf \"%s\" \"\$DATABASE_URL\" | tr -d '\\r\\n')

            echo '== Droplet verification =='
            python3 -c \"import os,urllib.parse; u=os.getenv('DATABASE_URL'); p=urllib.parse.urlparse(u); print(repr(u)); print('db path:',repr(p.path))\"

            printf 'DATABASE_URL=%s\n' \"\$DATABASE_URL\" > .env

            python3 scripts/deploy.py

            pm2 restart ${PM2_APP_NAME} --update-env
            pm2 save
          "
