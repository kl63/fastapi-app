name: Deploy FastAPI (Production)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add droplet to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 134.122.5.11 >> ~/.ssh/known_hosts

      - name: Deploy to droplet
        env:
          DROPLET_HOST: 134.122.5.11
          DROPLET_USER: kevinlin192003
          APP_DIR: /var/www/fastapi-app
          PM2_APP_NAME: fastapi-app
          DATABASE_URL_RAW: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail

          # --- sanitize DATABASE_URL from GitHub Secret (removes trailing newline / CRLF) ---
          DATABASE_URL_CLEAN="$(printf "%s" "$DATABASE_URL_RAW" | tr -d '\r\n')"

          # Safe local debug (doesn't print password)
          python3 - <<PY
          import urllib.parse
          u = "${DATABASE_URL_CLEAN}"
          p = urllib.parse.urlparse(u)
          print("LOCAL repr(DATABASE_URL_CLEAN):", repr(u))
          print("LOCAL repr(db path):", repr(p.path))
          PY

          ssh "${DROPLET_USER}@${DROPLET_HOST}" bash -s <<EOF
            set -euo pipefail

            cd "${APP_DIR}"

            echo "== Pull latest =="
            git fetch --all
            git reset --hard origin/main

            echo "== Ensure venv =="
            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "== Export clean DATABASE_URL for this session =="
            export DATABASE_URL="${DATABASE_URL_CLEAN}"
            export DATABASE_URL="\$(printf "%s" "\$DATABASE_URL" | tr -d '\r\n')"

            echo "== Safe debug on droplet =="
            python3 - <<'PY'
            import os, urllib.parse
            u = os.environ.get("DATABASE_URL","")
            p = urllib.parse.urlparse(u)
            print("DROPLET repr(DATABASE_URL):", repr(u))
            print("DROPLET repr(db path):", repr(p.path))
            PY

            echo "== (Optional) Write .env so manual runs match CI =="
            # If you prefer NOT to write .env, delete this block.
            # This keeps a consistent single-line DATABASE_URL with no CRLF.
            printf "DATABASE_URL=%s\n" "\$DATABASE_URL" > .env
            chmod 600 .env || true

            echo "== Run deploy script =="
            # Your repo already has scripts/deploy.py and it runs migrations.
            python3 scripts/deploy.py

            echo "== Restart PM2 with updated env =="
            pm2 restart "${PM2_APP_NAME}" --update-env
            pm2 save

            echo "== Done =="
          EOF
