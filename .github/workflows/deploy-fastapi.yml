name: Deploy FastAPI App

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  HOST: 134.122.5.11
  USERNAME: kevinlin192003
  REPO_URL: git@github.com:kl63/fastapi-app.git
  TARGET_DIR: /var/www/fastapi-app
  APP_NAME: fastapi-app

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to DigitalOcean
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -e

          # 1) Make sure target dir exists
          ssh -o StrictHostKeyChecking=no $USERNAME@$HOST "mkdir -p $TARGET_DIR"

          # 2) Write .env safely using base64 (prevents all quoting/syntax issues)
          ENV_B64="$(printf "DATABASE_URL=%s\n" "$DATABASE_URL" | base64 -w0)"
          ssh -o StrictHostKeyChecking=no $USERNAME@$HOST "echo '$ENV_B64' | base64 -d > $TARGET_DIR/.env"

          # 3) Deploy on the server
          ssh -o StrictHostKeyChecking=no $USERNAME@$HOST "bash -s" <<'EOF'
            set -euo pipefail

            REPO_URL="git@github.com:kl63/fastapi-app.git"
            TARGET_DIR="/var/www/fastapi-app"
            APP_NAME="fastapi-app"

            if [ ! -d "$TARGET_DIR/.git" ]; then
              git clone "$REPO_URL" "$TARGET_DIR"
            fi

            cd "$TARGET_DIR"
            git fetch origin
            git reset --hard origin/main

            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # Load env
            set -a
            source "$TARGET_DIR/.env"
            set +a

            echo "Running deploy script..."
            python scripts/deploy.py

            echo "Restarting PM2..."
            if ! command -v pm2 >/dev/null 2>&1; then
              npm install -g pm2
            fi

            pm2 restart "$APP_NAME" || \
              pm2 start /var/www/fastapi-app/venv/bin/gunicorn \
                --name "$APP_NAME" \
                --interpreter none -- \
                -w 1 -k uvicorn.workers.UvicornWorker main:app \
                --bind 127.0.0.1:8000 --timeout 120

            pm2 save
          EOF
